import shutil
import subprocess
import tempfile
from pathlib import Path


class TestScanner:
    test_dir = Path("test")
    vulnerable_file = (
        test_dir / "condensed-downloads" / "lftp_4.6.0-1+deb8u1_amd64.deb.tar.gz"
    )
    scanner = test_dir.parent / "src" / "scanner.py"

    @classmethod
    def setup_class(cls):
        cls.tmp_dir = Path(tempfile.mkdtemp(prefix="cve-bin-tool-scanner-"))
        cls.tmp_vulnerable_file = cls.tmp_dir / cls.vulnerable_file.name
        shutil.copy(cls.vulnerable_file, cls.tmp_vulnerable_file)

    @classmethod
    def teardown_class(cls):
        shutil.rmtree(cls.tmp_dir)

    def test_scanner(self):
        print(
            subprocess.run(
                [
                    "python",
                    str(self.scanner),
                    str(self.tmp_vulnerable_file),
                    "--repo",
                    "REPOSITORY",
                    "--run-id",
                    "RUNID",
                    "--sarif-output",
                    str(self.tmp_dir / "output.sarif"),
                    "--html-pdf-output",
                    str(self.tmp_dir / "report"),
                ]
            )
        )
        with open(self.tmp_dir / "output.sarif") as fd:
            print(fd.read())
        exit()
