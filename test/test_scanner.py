import shutil
import subprocess
import tempfile
from pathlib import Path


class TestScanner:
    SARIF_OUTPUT = """{"$schema": "https://json.schemastore.org/sarif-2.1.0.json", "version": "2.1.0", "runs": [{"tool": {"driver": {"name": "CVE Binary Tool", "semanticVersion": "3.2.2dev0", "rules": [{"id": "@cve-bin-tool/html_pdf_report", "name": "HTML & PDF Scan reports by CVE Binary Tool", "shortDescription": {"text": "HTML & PDF Scan reports by CVE Binary Tool"}, "fullDescription": {"text": "HTML & PDF reports provide detailed insight of the CVEs and make them easy to track. These results get automatically updated eachtime when the CVE Binary Tool GitHub Action runs. You can disable this just by dismissing the alert, then you won't receive any further HTML/PDF reports."}, "defaultConfiguration": {"level": "warning"}, "properties": {"tags": ["scan reports"], "precision": "medium"}}, {"id": "d751c0c9", "shortDescription": {"text": "Vulnerable components found in lftp_4.6.0-1+deb8u1_amd64.deb.tar.gz"}, "help": {"text": "", "markdown": "**Basic information about `CVE-2018-10916`:**<br/>It has been discovered that lftp up to and including version 4.8.3 does not properly sanitize remote file names, leading to a loss of integrity on the local system when reverse mirroring is used. A remote attacker may trick a user to use reverse mirroring on an attacker controlled FTP server, resulting in the removal of all files in the current working directory of the victim's system.<br/><br/>"}, "properties": {"tags": ["vulnerablity"], "precision": "high", "security-severity": "6.5"}}]}}, "results": [{"ruleId": "@cve-bin-tool/html_pdf_report", "message": {"text": "Here is the HTML & PDF Scan Reports: https://github.com/REPOSITORY/actions/runs/RUNID. To download the reports, first click on the link and scroll down to the 'Artifacts' section then click on 'cve_reports'."}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "*"}}}]}, {"ruleId": "d751c0c9", "message": {"text": "Product Name: lftp<br/>Version: 4.6.0<br/><br/>CVE ID: CVE-2018-10916<br/>CVE Score: 6.5<br/>CVE Severity: MEDIUM<br/>Patched Version: v4.8.4-1<br/>CVE Remark: NewFound<br/>Source: https://nvd.nist.gov/vuln/detail/CVE-2018-10916<br/><br/>"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "lftp_4.6.0-1+deb8u1_amd64.deb.tar.gz"}}}]}]}]}"""
    TEST_DIR = Path("test")
    VULNERABLE_FILE = (
        TEST_DIR / "condensed-downloads" / "lftp_4.6.0-1+deb8u1_amd64.deb.tar.gz"
    )
    SCANNER = TEST_DIR.parent / "src" / "scanner.py"

    @classmethod
    def setup_class(cls):
        cls.tmp_dir = Path(tempfile.mkdtemp(prefix="cve-bin-tool-scanner-"))
        cls.tmp_vulnerable_file = cls.tmp_dir / cls.VULNERABLE_FILE.name
        shutil.copy(cls.VULNERABLE_FILE, cls.tmp_vulnerable_file)

    @classmethod
    def teardown_class(cls):
        shutil.rmtree(cls.tmp_dir)

    def test_scanner(self):
        subprocess.run(
            [
                "python",
                str(self.SCANNER),
                str(self.tmp_vulnerable_file),
                "--repo",
                "REPOSITORY",
                "--run-id",
                "RUNID",
                "--sarif-output",
                str(self.tmp_dir / "output.sarif"),
                "--html-pdf-output",
                str(self.tmp_dir / "report"),
            ]
        )
        with open(self.tmp_dir / "output.sarif") as fd:
            assert fd.read() == self.SARIF_OUTPUT
        assert (self.tmp_dir / "report.html").exists() and (
            self.tmp_dir / "report.pdf"
        ).exists()
